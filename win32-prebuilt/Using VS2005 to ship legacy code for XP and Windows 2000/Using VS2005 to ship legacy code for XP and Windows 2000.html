<HTML>
<BODY>
  <div style="padding-left: 20px; text-indent: -16px;">Newsgroups: <b>microsoft.public.vc.mfc</b></div>
  <div style="padding-left: 20px; text-indent: -16px;">From: <b>"Alan Klietz" &lt;al<a target="_parent" href="http://groups.google.com/groups/unlock?msg=892541407fa765dc&amp;_done=/group/microsoft.public.vc.mfc/browse_thread/thread/3f8a215607dfc5cc/71f145cf9ddd9a08%3Flnk%3Dstrnum%3D5">...</a>@newsgroup.nospam&gt;</b></div>
  <div style="padding-left: 20px; text-indent: -16px;">Date: <b>Mon, 13 Feb 2006 18:05:42 -0600</b></div>
  <div style="padding-left: 20px; text-indent: -16px;">Local: <b>Tues, Feb 14 2006 10:05 am
</b></div>
  <div style="padding-left: 20px; text-indent: -16px;">Subject: <b>Using VS2005 to ship legacy code for XP and Windows 2000.</b></div>


If you want to publish a Windows application that runs on Windows 2000 or <br> Windows XP, using the latest compiler (Visual Studio 2005), you can do so. <br> Without requiring that you ship megabytes of code from the VS2005 runtime <br> libraries (MSVCRT80.DLL and MFC80.DLL). <br> <p>Follow these steps: <br> </p><p>1) Install the Windows Server 2003 SP1 Platform SDK (April 2005 Edition). <br> The April 2005 PSDK bundles the VS 2005 compiler (version 14.0) and its <br> associated include headers and libraries.  With VC6 installed it allows you <br> to link VC6 compatible apps for 32-bit applications. <br> 2) You won't be able to use the 64-bit compiler bundled with the April 2005 <br> PSDK on your 32-bit apps.  But (and this is the key trick) you can use <br> Visual Studio 2005's compiler with the April 2005 PSDK.  Just point Visual <br> Studio 2005's INCLUDE folders at the PSSDK folders: include\mfc, <br> include\atl, and include\crt.   Point the LIB folder to your original VC6 <br> installation.  Now you can compile with Visual Studio 2005 and link <br> correctly with MFC42.LIB and MSVCRT.LIB while enjoying all the new IDE <br> goodies and security checking of Visual Studio 2005. <br> </p><p>You still need the VS 2005 version of RunTmChk.lib and sehprolg.obj in order <br> to write the __security_check_cookie stub.  (See Matt Pietrek's postings for <br> more info on this topic.) <br> </p><p>To fix the remaining link errors with CxxFrameHandler3 and alloca use the <br> following: <br> </p><p>   .386 <br>    .model flat <br>    ; <br>    ; vc8-to-vc6 bridge assembly code. <br>    ; <br>    ; This module patches up gaps in order to a build a bridge to connect our <br> code <br>    ; compiled with the VC8 compiler and with the code in the VC6 runtime <br> library. <br>    ; <br>    ; Trampoline from ___CxxFrameHandler3 --&gt; ___CxxFrameHandler <br>    ; <br>    ; ___CxxFrameHandler[n] is called for try/catch blocks (C++) <br>    ; <br>    ; See "How a C++ compiler implements exception handling" <br>    ; <a target="_blank" rel="nofollow" href="http://www.codeproject.com/cpp/exceptionhandler.asp">http://www.codeproject.com/cpp/exceptionhandler.asp</a> <br> </p><p>   ; <br> </p><p>   ; MSVCRT.DLL <br>    extrn __imp____CxxFrameHandler:dword  ; external memory addr <br> </p><p>public  ___CxxFrameHandler3 <br> </p><p>___CxxFrameHandler3 proc near <br> </p><p>   ; Jump indirect: Jumps to (*__imp__CxxFrameHandler) <br>    jmp  __imp____CxxFrameHandler  ; Trampoline bounce <br> </p><p>___CxxFrameHandler3 endp <br> </p><p>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; <br> </p><p>   extrn __chkstk:abs   ; Absolute external constant <br> </p><p>   public __alloca_probe_16 <br> __alloca_probe_16 proc near <br> </p><p>arg_0  = dword ptr  8 <br>    push    ecx <br>    lea     ecx, [esp+arg_0] <br>    sub     ecx, eax <br>    and     ecx, 0Fh <br>    add     eax, ecx <br>    sbb     ecx, ecx <br>    or      eax, ecx <br>    pop     ecx <br>    jmp     near ptr __chkstk <br> </p><p>__alloca_probe_16 endp <br> </p><p>   public __alloca_probe_8 <br> __alloca_probe_8 proc near <br> arg_0           = dword ptr  8 <br>    push    ecx <br>    lea     ecx, [esp+arg_0] <br>    sub     ecx, eax <br>    and     ecx, 7 <br>    add     eax, ecx <br>    sbb     ecx, ecx <br>    or      eax, ecx <br>    pop     ecx <br>    jmp     near ptr __chkstk <br> </p><p>__alloca_probe_8 endp <br> </p><p>-- Alan Klietz (alank at NOSPAM algintech dot com) <br>
</BODY>
</HTML>
